---
- name: Aktualizacja OS
  hosts: linux
  become: true
  gather_facts: yes
  vars_files:
    - vault.yaml

  tasks:
    - name: Sekcja aktualizacji z obs≈ÇugƒÖ b≈Çƒôd√≥w
      block:
        - name: Upgrade pakiet√≥w do najnowszej wersji
          ansible.builtin.apt:
            upgrade: safe
            update_cache: yes
            autoclean: yes
            autoremove: yes
          environment:
            DEBIAN_FRONTEND: noninteractive
          register: upgrade_result

        - name: Weryfikacja potrzeby restartu
          ansible.builtin.stat:
            path: /var/run/reboot-required
          register: reboot_required

        - name: Powiadomienie Discord - SUKCES
          community.general.discord:
            webhook_id: "{{ discord_webhook_id }}"
            webhook_token: "{{ discord_webhook_token }}"
            username: "Semaphore"
            content: "‚úÖ **SUKCES** - Aktualizacja systemu **{{ ansible_hostname }}** ({{ ansible_default_ipv4.address }}) zako≈Ñczona pomy≈õlnie!\n\nüì¶ Zmienione pakiety: {{ 'TAK' if upgradeapt.changed else 'NIE (system aktualny)' }}\nüïê Data: {{ ansible_date_time.date }} {{ ansible_date_time.time }}"
          delegate_to: localhost
          become: no

        - name: Podsumowanie operacji
          ansible.builtin.debug:
            msg:
              - "Aktualizacja zako≈Ñczona pomy≈õlnie"
              - "Restart wymagany: {{ 'TAK' if reboot_required.stat.exists else 'NIE' }}"

      rescue:
        - name: Wy≈õwietlenie sekret√≥w z vaulta
          ansible.builtin.debug:
            msg:
              - "=== SEKRETY Z VAULTA ==="
              - "discord_webhook_id: {{ discord_webhook_id | default('NIE ZDEFINIOWANE') }}"
              - "discord_webhook_token: {{ discord_webhook_token | default('NIE ZDEFINIOWANE') }}"
              - "=== WSZYSTKIE ZMIENNE ==="
            var: vars

        - name: Powiadomienie Discord o b≈Çƒôdzie
          community.general.discord:
            webhook_id: "{{ discord_webhook_id }}"
            webhook_token: "{{ discord_webhook_token }}"
            embeds:
              - title: "‚ö†Ô∏è B≈ÅƒÑD AKTUALIZACJI SYSTEMU"
                description: "Aktualizacja systemu zako≈Ñczy≈Ça siƒô b≈Çƒôdem"
                color: 15158332
                fields:
                  - name: "Serwer"
                    value: "{{ inventory_hostname }}"
                  - name: "Data"
                    value: "{{ ansible_date_time.iso8601 }}"
                  - name: "B≈ÇƒÖd"
                    value: "{{ ansible_failed_result.msg | default('Nieznany b≈ÇƒÖd') }}"
                timestamp: "{{ ansible_date_time.iso8601 }}"
          delegate_to: localhost
          become: no
          when: discord_webhook_id != "" and discord_webhook_token != ""

        - name: Zako≈Ñczenie z b≈Çƒôdem
          ansible.builtin.fail:
            msg: "Aktualizacja zako≈Ñczy≈Ça siƒô b≈Çƒôdem"