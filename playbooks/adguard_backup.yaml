---
- name: Backup AdGuard Home
  hosts: agh
  become: true
  gather_facts: true
  ignore_unreachable: true
  vars_files:
    - vault.yaml
  vars:
    adguard_dir: /adguardhome
    backup_dir: /home/user/backups/adguard

  tasks:
    - name: Init statusu
      ansible.builtin.set_fact:
        backup_failed: false
        backup_error_msg: ""

    - name: Główny blok wykonywania kopii zapasowej
      block:
        - name: Przygotowanie lokalnego katalogu backup
          ansible.builtin.file:
            path: "{{ backup_dir }}"
            state: directory
            mode: '0755'
          delegate_to: localhost
          become: no

        - name: Zatrzymanie AdGuard Home przed backupem
          ansible.builtin.systemd:
            name: AdGuardHome
            state: stopped

        - name: Kompresja katalogu AdGuard Home
          community.general.archive:
            path: "{{ adguard_dir }}"
            dest: /tmp/adguard_backup_{{ ansible_date_time.date }}.tar.gz
            format: gz

        - name: Przywrócenie działania AdGuard Home
          ansible.builtin.systemd:
            name: AdGuardHome
            state: started

        - name: Transfer archiwum do maszyny kontrolnej
          ansible.builtin.fetch:
            src: /tmp/adguard_backup_{{ ansible_date_time.date }}.tar.gz
            dest: "{{ backup_dir }}/adguard_backup_{{ ansible_date_time.date }}.tar.gz"
            flat: yes

        - name: Usunięcie pliku tymczasowego z hosta docelowego
          ansible.builtin.file:
            path: /tmp/adguard_backup_{{ ansible_date_time.date }}.tar.gz
            state: absent

        - name: Wyszukiwanie przestarzałych backupów
          ansible.builtin.find:
            paths: "{{ backup_dir }}"
            patterns: "adguard_backup_*.tar.gz"
            age: 7d
          register: old_backups
          delegate_to: localhost
          become: no

        - name: Usuwanie przestarzałych plików backup
          ansible.builtin.file:
            path: "{{ item.path }}"
            state: absent
          loop: "{{ old_backups.files }}"
          delegate_to: localhost
          become: no

        - name: Informacja o zakończeniu procesu
          ansible.builtin.debug:
            msg:
              - "Kopia zapasowa AdGuard Home zakończona pomyślnie"
              - "Lokalizacja: {{ backup_dir }}/adguard_backup_{{ ansible_date_time.date }}.tar.gz"
              - "Serwer: {{ inventory_hostname }}"

      rescue:
        - name: Przywrócenie usługi w przypadku błędu
          ansible.builtin.systemd:
            name: AdGuardHome
            state: started
          ignore_errors: yes

        - name: Zapisanie statusu błędu
          ansible.builtin.set_fact:
            backup_failed: true
            backup_error_msg: "{{ ansible_failed_result.msg | default('Nieznany błąd') }}"

        - name: Powiadomienie Discord o błędzie
          community.general.discord:
            webhook_id: "{{ discord_webhook_id }}"
            webhook_token: "{{ discord_webhook_token }}"
            embeds:
              - title: "⚠️ BŁĄD KOPII ZAPASOWEJ AdGuard Home"
                description: "Tworzenie kopii zapasowej zakończyło się błędem"
                color: 15158332
                fields:
                  - name: "Serwer"
                    value: "{{ inventory_hostname }}"
                  - name: "Data"
                    value: "{{ ansible_date_time.iso8601 }}"
                  - name: "Błąd"
                    value: "{{ backup_error_msg | default('Nieznany błąd') }}"
                timestamp: "{{ ansible_date_time.iso8601 }}"
          delegate_to: localhost
          become: no
          ignore_errors: yes
          when:
            - (discord_webhook_id | default('') | length) > 0
            - (discord_webhook_token | default('') | length) > 0

        - name: Zakończenie z błędem
          ansible.builtin.debug:
            msg: "Backup miał błąd, ale job ma zostać oznaczony jako SUCCESS (zgodnie z wymaganiem)."

      always:
        - name: Stat pliku backup
          ansible.builtin.stat:
            path: "{{ backup_dir }}/adguard_backup_{{ ansible_date_time.date }}.tar.gz"
          register: backup_stat
          delegate_to: localhost
          become: no
          ignore_errors: yes

        - name: Uruchom AdGuard
          ansible.builtin.systemd:
            name: AdGuardHome
            state: started
          ignore_errors: yes

        - name: Powiadomienie Discord o sukcesie
          community.general.discord:
            webhook_id: "{{ discord_webhook_id }}"
            webhook_token: "{{ discord_webhook_token }}"
            embeds:
              - title: "✅ Backup AdGuard Home - SUKCES"
                description: "Kopia zapasowa zakończona pomyślnie"
                color: 3066993
                fields:
                  - name: "Serwer"
                    value: "{{ inventory_hostname }}"
                  - name: "Data"
                    value: "{{ ansible_date_time.iso8601 }}"
                  - name: "Plik"
                    value: "{{ backup_dir }}/adguard_backup_{{ ansible_date_time.date }}.tar.gz"
                  - name: "Rozmiar"
                    value: >-
                      {{
                        (
                          (backup_stat.stat.size / 1024 / 1024) | round(2) ~ ' MB'
                        )
                        if (backup_stat is defined and backup_stat.stat is defined and backup_stat.stat.size is defined)
                        else 'n/a'
                      }}
                timestamp: "{{ ansible_date_time.iso8601 }}"
          delegate_to: localhost
          become: no
          ignore_errors: yes
          when:
            - not backup_failed
            - (discord_webhook_id | default('') | length) > 0
            - (discord_webhook_token | default('') | length) > 0
