---
- name: Backup AdGuard Home
  hosts: agh
  become: true
  vars_files:
    - vault.yaml
  vars:
    adguard_dir: /adguardhome
    backup_dir: /home/user/backups/adguard
    
  tasks:
    - name: Główny blok wykonywania kopii zapasowej
      block:
        - name: Przygotowanie lokalnego katalogu backup
          ansible.builtin.file:
            path: "{{ backup_dir }}"
            state: directory
            mode: '0755'
          delegate_to: localhost
          become: no

        - name: Zatrzymanie AdGuard Home przed backupem
          ansible.builtin.systemd:
            name: AdGuardHome
            state: stopped

        - name: Kompresja katalogu AdGuard Home
          community.general.archive:
            path: "{{ adguard_dir }}"
            dest: /tmp/adguard_backup_{{ ansible_date_time.date }}.tar.gz
            format: gz

        - name: Przywrócenie działania AdGuard Home
          ansible.builtin.systemd:
            name: AdGuardHome
            state: started

        - name: Transfer archiwum do maszyny kontrolnej
          ansible.builtin.fetch:
            src: /tmp/adguard_backup_{{ ansible_date_time.date }}.tar.gz
            dest: "{{ backup_dir }}/adguard_backup_{{ ansible_date_time.date }}.tar.gz"
            flat: yes

        - name: Usunięcie pliku tymczasowego z hosta docelowego
          ansible.builtin.file:
            path: /tmp/adguard_backup_{{ ansible_date_time.date }}.tar.gz
            state: absent

        - name: Wyszukiwanie przestarzałych backupów
          ansible.builtin.find:
            paths: "{{ backup_dir }}"
            patterns: "adguard_backup_*.tar.gz"
            age: 7d
          register: old_backups
          delegate_to: localhost
          become: no

        - name: Usuwanie przestarzałych plików backup
          ansible.builtin.file:
            path: "{{ item.path }}"
            state: absent
          loop: "{{ old_backups.files }}"
          delegate_to: localhost
          become: no

        - name: Informacja o zakończeniu procesu
          ansible.builtin.debug:
            msg:
              - "Kopia zapasowa AdGuard Home zakończona pomyślnie"
              - "Lokalizacja: {{ backup_dir }}/adguard_backup_{{ ansible_date_time.date }}.tar.gz"
              - "Serwer: {{ inventory_hostname }}"

      rescue:
        - name: Przywrócenie usługi w przypadku błędu
          ansible.builtin.systemd:
            name: AdGuardHome
            state: started
          ignore_errors: yes

        - name: Powiadomienie Discord o błędzie
          community.general.discord:
            webhook_id: "{{ discord_webhook_id }}"
            webhook_token: "{{ discord_webhook_token }}"
            embeds:
              - title: "⚠️ BŁĄD KOPII ZAPASOWEJ AdGuard Home"
                description: "Tworzenie kopii zapasowej zakończyło się błędem"
                color: 15158332
                fields:
                  - name: "Serwer"
                    value: "{{ inventory_hostname }}"
                  - name: "Data"
                    value: "{{ ansible_date_time.iso8601 }}"
                  - name: "Błąd"
                    value: "{{ ansible_failed_result.msg | default('Nieznany błąd') }}"
                timestamp: "{{ ansible_date_time.iso8601 }}"
          delegate_to: localhost
          become: no
          when: discord_webhook_id != "" and discord_webhook_token != ""

        - name: Zakończenie z błędem
          ansible.builtin.fail:
            msg: "Kopia zapasowa zakończyła się błędem"